<!-- 導航欄 -->
<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="nav-brand">TYNLC管理系統</a>
        <button class="nav-toggle" onclick="toggleNav()">☰</button>
        <div class="nav-links" id="navLinks">
            <!-- 出席管理 -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn" onclick="toggleDropdown('attendance')">
                    出席管理 <span class="dropdown-arrow">▼</span>
                </button>
                <div class="nav-dropdown-content" id="attendance-dropdown">
                    <a href="/attendance/query" class="nav-link">出席查詢</a>
                    <a href="/attendance/report" class="nav-link">民數回報</a>
                </div>
            </div>
            
            {% if request.session.get('user_id') %}
                <!-- 使用者管理 -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn" onclick="toggleDropdown('user')">
                        使用者管理 <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content" id="user-dropdown">
                        <a href="/user/create" class="nav-link">新增使用者</a>
                        <a href="/user/update" class="nav-link">更新使用者</a>
                        <a href="/user/delete" class="nav-link">刪除使用者</a>
                    </div>
                </div>
                
                <!-- 組織管理 -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn" onclick="toggleDropdown('organization')">
                        組織管理 <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content" id="organization-dropdown">
                        <a href="/organization-category/create" class="nav-link">新增組織類別</a>
                        <a href="/organization-unit/create" class="nav-link">新增組織單位</a>
                        <a href="/organization-units/update" class="nav-link">更新組織單位</a>
                    </div>
                </div>
                
                <div class="user-info">
                    歡迎，{{ request.session.get('user_name') }}
                    <form method="POST" action="/logout" style="display: inline;">
                        <button type="submit" class="logout-btn">登出</button>
                    </form>
                </div>
            {% else %}
                <div class="nav-group">
                    <a href="/login" class="nav-link">登入</a>
                    <a href="/register" class="nav-link">註冊</a>
                </div>
            {% endif %}
        </div>
    </div>
</nav>

<style>
/* 強制隱藏所有下拉選單 - 最高優先權 */
.navbar .nav-links .nav-dropdown .nav-dropdown-content {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    background-color: #5a3085 !important;
    min-width: 180px !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
    border-radius: 4px !important;
    z-index: 1000 !important;
    padding: 0.5rem 0 !important;
    transform: translateY(-10px) !important;
    transition: all 0.3s ease !important;
    pointer-events: none !important;
}

/* 顯示活動的下拉選單 */
.navbar .nav-links .nav-dropdown .nav-dropdown-content.active {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    transform: translateY(0) !important;
    pointer-events: auto !important;
}

/* 手機版覆蓋 */
@media (max-width: 768px) {
    .navbar .nav-links .nav-dropdown .nav-dropdown-content {
        position: static !important;
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        max-height: 0 !important;
        overflow: hidden !important;
        background-color: transparent !important;
        box-shadow: none !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin-top: 0 !important;
        transition: all 0.3s ease !important;
        transform: none !important;
    }
    
    .navbar .nav-links .nav-dropdown .nav-dropdown-content.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        max-height: 300px !important;
        padding: 0.5rem 0 0 1rem !important;
        margin-top: 0.5rem !important;
    }
}
</style>

<script>
// 確保頁面載入時所有下拉選單都是隱藏的
document.addEventListener('DOMContentLoaded', function() {
    // 強制隱藏所有下拉選單
    const allDropdowns = document.querySelectorAll('.nav-dropdown-content');
    allDropdowns.forEach(function(dropdown) {
        dropdown.classList.remove('active');
        dropdown.style.display = 'none';
    });
});

function toggleNav() {
    const navLinks = document.getElementById('navLinks');
    navLinks.classList.toggle('active');
}

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId + '-dropdown');
    const button = dropdown.previousElementSibling;
    const arrow = button.querySelector('.dropdown-arrow');
    
    // Close other dropdowns
    closeAllDropdowns(dropdownId);
    
    // Toggle current dropdown
    const isActive = dropdown.classList.contains('active');
    
    if (isActive) {
        dropdown.classList.remove('active');
        dropdown.style.display = 'none';
        arrow.classList.remove('rotated');
    } else {
        dropdown.classList.add('active');
        dropdown.style.display = 'block';
        arrow.classList.add('rotated');
    }
}

function closeAllDropdowns(exceptId) {
    const dropdowns = document.querySelectorAll('.nav-dropdown-content');
    const arrows = document.querySelectorAll('.dropdown-arrow');
    
    dropdowns.forEach(function(dropdown) {
        if (!exceptId || dropdown.id !== exceptId + '-dropdown') {
            dropdown.classList.remove('active');
            dropdown.style.display = 'none';
        }
    });
    
    arrows.forEach(function(arrow) {
        if (!exceptId || !arrow.closest('.nav-dropdown').querySelector('#' + exceptId + '-dropdown')) {
            arrow.classList.remove('rotated');
        }
    });
}

// Close navigation when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.getElementById('navLinks');
    const navToggle = document.querySelector('.nav-toggle');
    
    // Close nav when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInsideNav = navLinks.contains(event.target);
        const isClickOnToggle = navToggle.contains(event.target);
        const isDropdownButton = event.target.closest('.nav-dropdown-btn');
        
        if (!isClickInsideNav && !isClickOnToggle && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            closeAllDropdowns();
        }
        
        // Close dropdowns when clicking outside
        if (!isClickInsideNav && !isDropdownButton) {
            closeAllDropdowns();
        }
    });
    
    // Close nav when touching outside (for touch devices)
    document.addEventListener('touchstart', function(event) {
        const isClickInsideNav = navLinks.contains(event.target);
        const isClickOnToggle = navToggle.contains(event.target);
        const isDropdownButton = event.target.closest('.nav-dropdown-btn');
        
        if (!isClickInsideNav && !isClickOnToggle && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            closeAllDropdowns();
        }
        
        // Close dropdowns when touching outside
        if (!isClickInsideNav && !isDropdownButton) {
            closeAllDropdowns();
        }
    });
    
    // Close nav when clicking on nav links (mobile)
    const navLinksElements = navLinks.querySelectorAll('.nav-link');
    navLinksElements.forEach(function(link) {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                navLinks.classList.remove('active');
                closeAllDropdowns();
            }
        });
    });
});
</script>