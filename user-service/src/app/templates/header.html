<!-- 導航欄 -->
<nav class="navbar">
    <div class="nav-container">
        <a href="/" class="nav-brand">TYNLC管理系統</a>
        <button class="nav-toggle" onclick="toggleNav()">☰</button>
        <div class="nav-links" id="navLinks">
            <!-- 出席管理 -->
            <div class="nav-dropdown">
                <button class="nav-dropdown-btn" onclick="toggleDropdown('attendance')">
                    出席管理 <span class="dropdown-arrow">▼</span>
                </button>
                <div class="nav-dropdown-content" id="attendance-dropdown">
                    <a href="/attendance/query" class="nav-link">出席查詢</a>
                    <a href="/attendance/report" class="nav-link">民數回報</a>
                </div>
            </div>
            
            {% if request.session.get('user_id') %}
                <!-- 使用者管理 -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn" onclick="toggleDropdown('user')">
                        使用者管理 <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content" id="user-dropdown">
                        <a href="/user/create" class="nav-link">新增使用者</a>
                        <a href="/user/update" class="nav-link">更新使用者</a>
                        <a href="/user/delete" class="nav-link">刪除使用者</a>
                    </div>
                </div>
                
                <!-- 組織管理 -->
                <div class="nav-dropdown">
                    <button class="nav-dropdown-btn" onclick="toggleDropdown('organization')">
                        組織管理 <span class="dropdown-arrow">▼</span>
                    </button>
                    <div class="nav-dropdown-content" id="organization-dropdown">
                        <a href="/organization-category/create" class="nav-link">新增組織類別</a>
                        <a href="/organization-unit/create" class="nav-link">新增組織單位</a>
                        <a href="/organization-units/update" class="nav-link">更新組織單位</a>
                    </div>
                </div>
                
                <div class="user-info">
                    歡迎，{{ request.session.get('user_name') }}
                    <form method="POST" action="/logout" style="display: inline;">
                        <button type="submit" class="logout-btn">登出</button>
                    </form>
                </div>
            {% else %}
                <div class="nav-group">
                    <a href="/login" class="nav-link">登入</a>
                    <a href="/register" class="nav-link">註冊</a>
                </div>
            {% endif %}
        </div>
    </div>
</nav>

<script>
function toggleNav() {
    const navLinks = document.getElementById('navLinks');
    navLinks.classList.toggle('active');
}

function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId + '-dropdown');
    const button = dropdown.previousElementSibling;
    const arrow = button.querySelector('.dropdown-arrow');
    
    // Close other dropdowns
    closeAllDropdowns(dropdownId);
    
    // Toggle current dropdown
    dropdown.classList.toggle('active');
    arrow.classList.toggle('rotated');
}

function closeAllDropdowns(exceptId) {
    const dropdowns = document.querySelectorAll('.nav-dropdown-content');
    const arrows = document.querySelectorAll('.dropdown-arrow');
    
    dropdowns.forEach(function(dropdown) {
        if (!exceptId || dropdown.id !== exceptId + '-dropdown') {
            dropdown.classList.remove('active');
        }
    });
    
    arrows.forEach(function(arrow) {
        if (!exceptId || !arrow.closest('.nav-dropdown').querySelector('#' + exceptId + '-dropdown')) {
            arrow.classList.remove('rotated');
        }
    });
}

// Close navigation when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const navLinks = document.getElementById('navLinks');
    const navToggle = document.querySelector('.nav-toggle');
    
    // Close nav when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInsideNav = navLinks.contains(event.target);
        const isClickOnToggle = navToggle.contains(event.target);
        const isDropdownButton = event.target.closest('.nav-dropdown-btn');
        
        if (!isClickInsideNav && !isClickOnToggle && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            closeAllDropdowns();
        }
        
        // Close dropdowns when clicking outside
        if (!isClickInsideNav && !isDropdownButton) {
            closeAllDropdowns();
        }
    });
    
    // Close nav when touching outside (for touch devices)
    document.addEventListener('touchstart', function(event) {
        const isClickInsideNav = navLinks.contains(event.target);
        const isClickOnToggle = navToggle.contains(event.target);
        const isDropdownButton = event.target.closest('.nav-dropdown-btn');
        
        if (!isClickInsideNav && !isClickOnToggle && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            closeAllDropdowns();
        }
        
        // Close dropdowns when touching outside
        if (!isClickInsideNav && !isDropdownButton) {
            closeAllDropdowns();
        }
    });
    
    // Close nav when clicking on nav links (mobile)
    const navLinksElements = navLinks.querySelectorAll('.nav-link');
    navLinksElements.forEach(function(link) {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                navLinks.classList.remove('active');
                closeAllDropdowns();
            }
        });
    });
});
</script>